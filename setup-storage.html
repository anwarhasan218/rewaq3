<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إعداد مجلدات التخزين في Supabase</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="h4 mb-0">إعداد مجلدات التخزين في Supabase</h1>
            </div>
            <div class="card-body">
                <p>هذه الصفحة ستقوم بإنشاء مجلدات التخزين المطلوبة في Supabase:</p>
                <ul>
                    <li>المجلد الرئيسي: <code>student-documents</code></li>
                    <li>المجلدات الفرعية:
                        <ul>
                            <li><code>id-cards</code> - لصور بطاقات الهوية</li>
                            <li><code>qualifications</code> - لصور المؤهلات</li>
                            <li><code>payment-receipts</code> - لصور إيصالات الدفع</li>
                        </ul>
                    </li>
                </ul>
                
                <button id="setupButton" class="btn btn-primary mt-3">بدء الإعداد</button>
                
                <div class="log-container mt-4">
                    <div id="logOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // استخدم نفس بيانات الاتصال من ملف supabase.js
        const supabaseUrl = 'https://htgmfpqwmujznhzbpsoa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z21mcHF3bXVqem5oemJwc29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0ODA3OTksImV4cCI6MjA2MTA1Njc5OX0.3gqo0JGIdpJ2GlYYCIe1Ua8umMmcLs9l7G5-hcfKOSU';
        
        // إنشاء عميل Supabase
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // عناصر الصفحة
        const setupButton = document.getElementById('setupButton');
        const logOutput = document.getElementById('logOutput');
        
        // دالة لإضافة رسائل إلى سجل الأحداث
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.textContent = message;
            logEntry.className = type;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // دالة إعداد التخزين
        async function setupStorage() {
            setupButton.disabled = true;
            setupButton.textContent = 'جاري الإعداد...';
            
            try {
                log('بدء إنشاء مجلدات التخزين...');
                
                // 1. إنشاء المجلد الرئيسي (Bucket)
                try {
                    const { data: bucketData, error: bucketError } = await supabase
                        .storage
                        .createBucket('student-documents', {
                            public: true, // جعل المجلد عامًا للوصول
                            fileSizeLimit: 5242880 // 5 ميجابايت كحد أقصى لحجم الملف
                        });
                    
                    if (bucketError) {
                        if (bucketError.message.includes('already exists')) {
                            log('المجلد student-documents موجود بالفعل', 'success');
                        } else {
                            throw bucketError;
                        }
                    } else {
                        log('تم إنشاء المجلد student-documents بنجاح', 'success');
                    }
                } catch (error) {
                    log(`خطأ في إنشاء المجلد الرئيسي: ${error.message}`, 'error');
                }
                
                // 2. إنشاء سياسات للمجلد
                try {
                    // سياسة القراءة العامة
                    const { error: policyError } = await supabase
                        .rpc('create_storage_policy', {
                            bucket_name: 'student-documents',
                            policy_name: 'allow-public-read',
                            definition: JSON.stringify({
                                statements: [
                                    {
                                        effect: 'allow',
                                        principal: '*',
                                        actions: ['select'],
                                        resources: ['*']
                                    }
                                ]
                            })
                        });
                    
                    if (policyError) {
                        log(`خطأ في إنشاء سياسة القراءة: ${policyError.message}`, 'error');
                    } else {
                        log('تم إنشاء سياسة القراءة بنجاح', 'success');
                    }
                    
                    // سياسة الإضافة العامة
                    const { error: policyError2 } = await supabase
                        .rpc('create_storage_policy', {
                            bucket_name: 'student-documents',
                            policy_name: 'allow-public-insert',
                            definition: JSON.stringify({
                                statements: [
                                    {
                                        effect: 'allow',
                                        principal: '*',
                                        actions: ['insert'],
                                        resources: ['*']
                                    }
                                ]
                            })
                        });
                    
                    if (policyError2) {
                        log(`خطأ في إنشاء سياسة الإضافة: ${policyError2.message}`, 'error');
                    } else {
                        log('تم إنشاء سياسة الإضافة بنجاح', 'success');
                    }
                } catch (error) {
                    log(`خطأ في إنشاء السياسات: ${error.message}`, 'error');
                }
                
                // 3. إنشاء المجلدات الفرعية عن طريق رفع ملف وهمي ثم حذفه
                try {
                    // مجلد بطاقات الهوية
                    const { error: idCardError } = await supabase
                        .storage
                        .from('student-documents')
                        .upload('id-cards/.placeholder', new Blob(['placeholder']), {
                            contentType: 'text/plain'
                        });
                    
                    if (idCardError && !idCardError.message.includes('already exists')) {
                        log(`خطأ في إنشاء مجلد id-cards: ${idCardError.message}`, 'error');
                    } else {
                        log('تم إنشاء مجلد id-cards بنجاح', 'success');
                    }
                    
                    // مجلد المؤهلات
                    const { error: qualificationsError } = await supabase
                        .storage
                        .from('student-documents')
                        .upload('qualifications/.placeholder', new Blob(['placeholder']), {
                            contentType: 'text/plain'
                        });
                    
                    if (qualificationsError && !qualificationsError.message.includes('already exists')) {
                        log(`خطأ في إنشاء مجلد qualifications: ${qualificationsError.message}`, 'error');
                    } else {
                        log('تم إنشاء مجلد qualifications بنجاح', 'success');
                    }
                    
                    // مجلد إيصالات الدفع
                    const { error: paymentsError } = await supabase
                        .storage
                        .from('student-documents')
                        .upload('payment-receipts/.placeholder', new Blob(['placeholder']), {
                            contentType: 'text/plain'
                        });
                    
                    if (paymentsError && !paymentsError.message.includes('already exists')) {
                        log(`خطأ في إنشاء مجلد payment-receipts: ${paymentsError.message}`, 'error');
                    } else {
                        log('تم إنشاء مجلد payment-receipts بنجاح', 'success');
                    }
                } catch (error) {
                    log(`خطأ في إنشاء المجلدات الفرعية: ${error.message}`, 'error');
                }
                
                log('اكتمل إعداد مجلدات التخزين!', 'success');
            } catch (error) {
                log(`حدث خطأ عام: ${error.message}`, 'error');
            } finally {
                setupButton.disabled = false;
                setupButton.textContent = 'بدء الإعداد';
            }
        }
        
        // إضافة مستمع الحدث لزر الإعداد
        setupButton.addEventListener('click', setupStorage);
    </script>
</body>
</html>
